<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 技术揭秘</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="React源码解析">
    <link rel="preload" href="/just-react/assets/css/0.styles.4300949d.css" as="style"><link rel="preload" href="/just-react/assets/js/app.3ca5235f.js" as="script"><link rel="preload" href="/just-react/assets/js/2.ceab786f.js" as="script"><link rel="preload" href="/just-react/assets/js/8.fb63fdcd.js" as="script"><link rel="prefetch" href="/just-react/assets/js/10.85a9a20d.js"><link rel="prefetch" href="/just-react/assets/js/11.932b412d.js"><link rel="prefetch" href="/just-react/assets/js/12.f242cd2d.js"><link rel="prefetch" href="/just-react/assets/js/13.03453b62.js"><link rel="prefetch" href="/just-react/assets/js/14.1eca8eb4.js"><link rel="prefetch" href="/just-react/assets/js/15.dc2f6e5e.js"><link rel="prefetch" href="/just-react/assets/js/16.a18f2ae6.js"><link rel="prefetch" href="/just-react/assets/js/17.faab250d.js"><link rel="prefetch" href="/just-react/assets/js/18.5fbf02a3.js"><link rel="prefetch" href="/just-react/assets/js/19.f49e92b5.js"><link rel="prefetch" href="/just-react/assets/js/20.d286fee0.js"><link rel="prefetch" href="/just-react/assets/js/21.048ef0cd.js"><link rel="prefetch" href="/just-react/assets/js/22.6266ec24.js"><link rel="prefetch" href="/just-react/assets/js/23.499ba392.js"><link rel="prefetch" href="/just-react/assets/js/24.bf405dce.js"><link rel="prefetch" href="/just-react/assets/js/25.ce9b9c12.js"><link rel="prefetch" href="/just-react/assets/js/26.b9eeed1a.js"><link rel="prefetch" href="/just-react/assets/js/27.bb7812ac.js"><link rel="prefetch" href="/just-react/assets/js/28.7cf508b5.js"><link rel="prefetch" href="/just-react/assets/js/29.874fb249.js"><link rel="prefetch" href="/just-react/assets/js/3.540ccf28.js"><link rel="prefetch" href="/just-react/assets/js/30.16070aa2.js"><link rel="prefetch" href="/just-react/assets/js/31.f0fa4d21.js"><link rel="prefetch" href="/just-react/assets/js/32.64085e73.js"><link rel="prefetch" href="/just-react/assets/js/33.3aedd51d.js"><link rel="prefetch" href="/just-react/assets/js/34.701196c0.js"><link rel="prefetch" href="/just-react/assets/js/35.c834d299.js"><link rel="prefetch" href="/just-react/assets/js/4.10c8f825.js"><link rel="prefetch" href="/just-react/assets/js/5.e9b9f33b.js"><link rel="prefetch" href="/just-react/assets/js/6.bb2347f8.js"><link rel="prefetch" href="/just-react/assets/js/7.35de3e13.js"><link rel="prefetch" href="/just-react/assets/js/9.833803a9.js">
    <link rel="stylesheet" href="/just-react/assets/css/0.styles.4300949d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/just-react/" class="home-link router-link-active"><!----> <span class="site-name">React 技术揭秘</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  🙋‍♂️ 一起学习
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    点亮⭐不迷路
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/just-react/me.html" class="nav-link">
  🙋‍♂️ 一起学习
</a></div> <a href="https://github.com/BetaSu/just-react" target="_blank" rel="noopener noreferrer" class="repo-link">
    点亮⭐不迷路
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/just-react/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第一章 前置知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第二章 render阶段</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第三章 commit阶段</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第四章 Diff算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第五章 状态更新</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第六章 Hooks</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/just-react/hooks/prepare.html" class="sidebar-link">Hooks理念</a></li><li><a href="/just-react/hooks/create.html" aria-current="page" class="active sidebar-link">极简Hooks实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#更新是什么" class="sidebar-link">更新是什么</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#update数据结构" class="sidebar-link">update数据结构</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#状态如何保存" class="sidebar-link">状态如何保存</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#hook数据结构" class="sidebar-link">Hook数据结构</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#模拟react调度更新流程" class="sidebar-link">模拟React调度更新流程</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#计算state" class="sidebar-link">计算state</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#对触发事件进行抽象" class="sidebar-link">对触发事件进行抽象</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#在线demo" class="sidebar-link">在线Demo</a></li><li class="sidebar-sub-header"><a href="/just-react/hooks/create.html#与react的区别" class="sidebar-link">与React的区别</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>为了更好理解<code>Hooks</code>原理，这一节我们遵循<code>React</code>的运行流程，实现一个不到100行代码的极简<code>useState Hook</code>。</p> <p>这是<a href="/just-react/hooks/create.html#在线demo">在线Demo</a>，建议对照着代码来看本节内容。</p> <h2 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h2> <p>对于<code>useState Hook</code>，考虑如下例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以将工作分为两部分：</p> <ol><li>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</li> <li>组件<code>render</code>时<code>useState</code>返回的<code>num</code>为更新后的结果。</li></ol> <p>其中<code>步骤1</code>的<code>更新</code>可以分为<code>mount</code>和<code>update</code>：</p> <ol><li>调用<code>ReactDOM.render</code>会产生<code>mount</code>的<code>更新</code>，<code>更新</code>内容为<code>useState</code>的<code>initialValue</code>（即<code>0</code>）。</li> <li>点击<code>p</code>标签触发<code>updateNum</code>会产生一次<code>update</code>的<code>更新</code>，<code>更新</code>内容为<code>num =&gt; num + 1</code>。</li></ol> <p>接下来讲解这两个步骤如何实现。</p> <h2 id="更新是什么"><a href="#更新是什么" class="header-anchor">#</a> 更新是什么</h2> <blockquote><ol><li>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</li></ol></blockquote> <p>首先我们要明确<code>更新</code>是什么。</p> <p>在我们的极简例子中，<code>更新</code>就是如下数据结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新执行的函数</span>
  action<span class="token punctuation">,</span>
  <span class="token comment">// 与同一个Hook的其他更新形成链表</span>
  next<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于<code>App</code>来说，点击<code>p</code>标签产生的<code>update</code>的<code>action</code>为<code>num =&gt; num + 1</code>。</p> <p>如果我们改写下<code>App</code>的<code>onClick</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 之前</span>
<span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 之后</span>
<span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>那么点击<code>p</code>标签会产生三个<code>update</code>。</p> <h2 id="update数据结构"><a href="#update数据结构" class="header-anchor">#</a> update数据结构</h2> <p>这些<code>update</code>是如何组合在一起呢？</p> <p>答案是：他们会形成<code>环状单向链表</code>。</p> <p>调用<code>updateNum</code>实际调用的是<code>dispatchAction.bind(null, hook.queue)</code>，我们先来了解下这个函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建update</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 环状单向链表操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>

  <span class="token comment">// 模拟React开始调度更新</span>
  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>环状链表操作不太容易理解，这里我们详细讲解下。</p> <p>当产生第一个<code>update</code>（我们叫他<code>u0</code>），此时<code>queue.pending === null</code>。</p> <p><code>update.next = update;</code>即<code>u0.next = u0</code>，他会和自己首尾相连形成<code>单向环状链表</code>。</p> <p>然后<code>queue.pending = update;</code>即<code>queue.pending = u0</code></p> <div class="language-js extra-class"><pre class="language-js"><code>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u0 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> u0
                <span class="token operator">^</span>       <span class="token operator">|</span>
                <span class="token operator">|</span>       <span class="token operator">|</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre></div><p>当产生第二个<code>update</code>（我们叫他<code>u1</code>），<code>update.next = queue.pending.next;</code>，此时<code>queue.pending.next === u0</code>，
即<code>u1.next = u0</code>。</p> <p><code>queue.pending.next = update;</code>，即<code>u0.next = u1</code>。</p> <p>然后<code>queue.pending = update;</code>即<code>queue.pending = u1</code></p> <div class="language-js extra-class"><pre class="language-js"><code>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u1 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> u0   
                <span class="token operator">^</span>       <span class="token operator">|</span>
                <span class="token operator">|</span>       <span class="token operator">|</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre></div><p>你可以照着这个例子模拟插入多个<code>update</code>的情况，会发现<code>queue.pending</code>始终指向最后一个插入的<code>update</code>。</p> <p>这样做的好处是，当我们要遍历<code>update</code>时，<code>queue.pending.next</code>指向第一个插入的<code>update</code>。</p> <h2 id="状态如何保存"><a href="#状态如何保存" class="header-anchor">#</a> 状态如何保存</h2> <p>现在我们知道，<code>更新</code>产生的<code>update</code>对象会保存在<code>queue</code>中。</p> <p>不同于<code>ClassComponent</code>的实例可以存储数据，对于<code>FunctionComponent</code>，<code>queue</code>存储在哪里呢？</p> <p>答案是：<code>FunctionComponent</code>对应的<code>fiber</code>中。</p> <p>我们使用如下精简的<code>fiber</code>结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// App组件对应的fiber对象</span>
<span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存该FunctionComponent对应的Hooks链表</span>
  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 指向App函数</span>
  stateNode<span class="token operator">:</span> App
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="hook数据结构"><a href="#hook数据结构" class="header-anchor">#</a> Hook数据结构</h2> <p>接下来我们关注<code>fiber.memoizedState</code>中保存的<code>Hook</code>的数据结构。</p> <p>可以看到，<code>Hook</code>与<code>update</code>类似，都通过<code>链表</code>连接。不过<code>Hook</code>是<code>无环</code>的<code>单向链表</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>hook <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存update的queue，即上文介绍的queue</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 保存hook对应的state</span>
  memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
  <span class="token comment">// 与下一个Hook连接形成单向无环链表</span>
  next<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>注意区分<code>update</code>与<code>hook</code>的所属关系：</p> <p>每个<code>useState</code>对应一个<code>hook</code>对象。</p> <p>调用<code>const [num, updateNum] = useState(0);</code>时<code>updateNum</code>（即上文介绍的<code>dispatchAction</code>）产生的<code>update</code>保存在<code>useState</code>对应的<code>hook.queue</code>中。</p></div> <h2 id="模拟react调度更新流程"><a href="#模拟react调度更新流程" class="header-anchor">#</a> 模拟React调度更新流程</h2> <p>在上文<code>dispatchAction</code>末尾我们通过<code>schedule</code>方法模拟<code>React</code>调度更新流程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...创建update</span>
  
  <span class="token comment">// ...环状单向链表操作</span>

  <span class="token comment">// 模拟React开始调度更新</span>
  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们来实现他。</p> <p>我们用<code>isMount</code>变量指代是<code>mount</code>还是<code>update</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 首次render时是mount</span>
isMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新前将workInProgressHook重置为fiber保存的第一个Hook</span>
  workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token comment">// 触发组件render</span>
  fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组件首次render为mount，以后再触发的更新为update</span>
  isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过<code>workInProgressHook</code>变量指向当前正在工作的<code>hook</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
</code></pre></div><p>在组件<code>render</code>时，每当遇到下一个<code>useState</code>，我们移动<code>workInProgressHook</code>的指针。</p> <div class="language-js extra-class"><pre class="language-js"><code>workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
</code></pre></div><p>这样，只要每次组件<code>render</code>时<code>useState</code>的调用顺序及数量保持一致，那么始终可以通过<code>workInProgressHook</code>找到当前<code>useState</code>对应的<code>hook</code>对象。</p> <p>到此为止，我们已经完成第一步。</p> <blockquote><ol><li>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</li></ol></blockquote> <p>接下来实现第二步。</p> <blockquote><ol start="2"><li>组件<code>render</code>时<code>useState</code>返回的<code>num</code>为更新后的结果。</li></ol></blockquote> <h2 id="计算state"><a href="#计算state" class="header-anchor">#</a> 计算state</h2> <p>组件<code>render</code>时会调用<code>useState</code>，他的大体逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前useState使用的hook会被赋值该该变量</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...mount时需要生成hook对象</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...update时从workInProgressHook中取出该useState对应的hook</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...根据queue.pending中保存的update更新state</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们首先关注如何获取<code>hook</code>对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// mount时为该useState生成hook</span>
  hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    queue<span class="token operator">:</span> <span class="token punctuation">{</span>
      pending<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将hook插入fiber.memoizedState链表末尾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 移动workInProgressHook指针</span>
  workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// update时找到对应hook</span>
  hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
  <span class="token comment">// 移动workInProgressHook指针</span>
  workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>当找到该<code>useState</code>对应的<code>hook</code>后，如果该<code>hook.queue.pending</code>不为空（即存在<code>update</code>），则更新其<code>state</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// update执行前的初始state</span>
<span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取update环状单向链表中第一个update</span>
  <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行update action</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
    baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    <span class="token comment">// 最后一个update执行完后跳出循环</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span>

  <span class="token comment">// 清空queue.pending</span>
  hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将update action执行完后的state作为memoizedState</span>
hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>
</code></pre></div><p>完整代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      queue<span class="token operator">:</span> <span class="token punctuation">{</span>
        pending<span class="token operator">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
      next<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
      baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span>

    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="对触发事件进行抽象"><a href="#对触发事件进行抽象" class="header-anchor">#</a> 对触发事件进行抽象</h2> <p>最后，让我们抽象一下<code>React</code>的事件触发方式。</p> <p>通过调用<code>App</code>返回的<code>click</code>方法模拟组件<code>click</code>的行为。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="在线demo"><a href="#在线demo" class="header-anchor">#</a> 在线Demo</h2> <p>至此，我们完成了一个不到100行代码的<code>Hooks</code>。重要的是，他与<code>React</code>的运行逻辑相同。</p> <details class="custom-block details"><summary>精简Hooks的在线Demo</summary> <p>调用<code>window.click()</code>模拟组件点击事件。</p> <p>你也可以使用多个<code>useState</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num1<span class="token punctuation">,</span> updateNum1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num1: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum1</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://code.h5jun.com/woniq/1/edit?js,console" target="_blank" rel="noopener noreferrer">Demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></details> <h2 id="与react的区别"><a href="#与react的区别" class="header-anchor">#</a> 与React的区别</h2> <p>我们用尽可能少的代码模拟了<code>Hooks</code>的运行，但是相比<code>React Hooks</code>，他还有很多不足。以下是他与<code>React Hooks</code>的区别：</p> <ol><li><p><code>React Hooks</code>没有使用<code>isMount</code>变量，而是在不同时机使用不同的<code>dispatcher</code>。换言之，<code>mount</code>时的<code>useState</code>与<code>update</code>时的<code>useState</code>不是同一个函数。</p></li> <li><p><code>React Hooks</code>有中途跳过<code>更新</code>的优化手段。</p></li> <li><p><code>React Hooks</code>有<code>batchedUpdates</code>，当在<code>click</code>中触发三次<code>updateNum</code>，<code>精简React</code>会触发三次更新，而<code>React</code>只会触发一次。</p></li> <li><p><code>React Hooks</code>的<code>update</code>有<code>优先级</code>概念，可以跳过不高优先的<code>update</code>。</p></li></ol> <p>更多的细节，我们会在本章后续小节讲解。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BetaSu/just-react/edit/master/docs/hooks/create.md" target="_blank" rel="noopener noreferrer">为该章节纠错</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/23/2020, 3:19:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/just-react/hooks/prepare.html" class="prev">
        Hooks理念
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/just-react/assets/js/app.3ca5235f.js" defer></script><script src="/just-react/assets/js/2.ceab786f.js" defer></script><script src="/just-react/assets/js/8.fb63fdcd.js" defer></script>
  </body>
</html>
